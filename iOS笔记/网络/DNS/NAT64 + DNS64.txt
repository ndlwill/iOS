场景设定
客户端是 IPv6-only，没有 IPv4 栈；
服务端只有 IPv4 地址（比如 93.184.216.34，即 example.com）

NAT64 + DNS64 通信流程:
[IPv6-only 客户端]
        │
        │ 1. 发起 DNS 查询 AAAA 记录
        ▼
   ┌─────────────┐
   │  DNS64 服务器 │
   └─────────────┘
        │
        │ 2. 没有 AAAA，但有 A 记录（例：93.184.216.34）
        │    → 构造 IPv6 地址：64:ff9b::5d:b8:d8:22
        ▼
 [返回伪造的 AAAA 记录]
        │
        │ 3. 客户端连接 IPv6 地址：64:ff9b::5d:b8:d8:22
        ▼
   ┌─────────────┐
   │  NAT64 网关   │
   └─────────────┘
        │
        │ 4. NAT64 拆解 IPv6 地址：
        │    → 提取 IPv4 部分 93.184.216.34
        │    → 发起真正的 IPv4 TCP/UDP 请求
        ▼
   ┌────────────────────┐
   │ IPv4-only 服务端（93.184.216.34） │
   └────────────────────┘


数据返回流程
IPv4 服务器响应 → 送到 NAT64 网关
NAT64 网关封装为 IPv6 响应 → 发回客户端


你设备（IPv6-only）连的是 移动网络，流程如下：
客户端得到IPv6 地址：64:ff9b::5d:b8:d8:22后，
1. 你请求 example.com，发出的是：
TCP connect to 64:ff9b::5d:b8:d8:22
这条 IPv6 的连接请求，从你的设备（手机、终端）经过蜂窝网络发出去。

2. 这个请求去哪了？
是发送到了 中国移动的网络中（公网 IPv6 网络）。
中国移动作为运营商，它在其核心网络中部署了 NAT64 网关设备，负责接收这些带 64:ff9b::/96 前缀的 IPv6 请求。

3. 移动的 NAT64 网关怎么做？
识别这个 IPv6 地址前缀是 NAT64（比如 64:ff9b::/96）；
提取出最后 32 位，反解成 IPv4（这里是 93.184.216.34）；
用自己的公网 IPv4 出口 NAT 发出连接；
同时维护 NAT 映射表，等服务端返回时可以映射回你的连接。


你不是直接和服务器通信；
而是先发给移动的核心网 NAT64 网关；
移动网的 NAT64 网关替你和 IPv4-only 的服务器通信；
然后把响应再转回给你。


NAT64 网关本身在运营商网络里可能只有一个或几个 公网 IPv4 地址。
当 NAT64 网关帮 IPv6-only 设备发起访问 IPv4-only 服务器时，
它得用这些公网 IPv4 地址作为源 IP，才能被公网服务器识别和响应。


NAT（Network Address Translation） 是一种技术，用来让私有网络内的设备共享一个公网 IP 地址访问互联网。
典型例子是家庭路由器给你家里多台设备分配局域网 IP（比如 192.168.x.x），
它们访问外网时，会把私网 IP 映射成一个公网 IP 地址 + 端口号，
这样外网只看到这个公网 IP。


==================================================
ipv4only.arpa
不可能同时返回 A 和 AAAA 记录给 ipv4only.arpa 这个域名。它 只注册了 A 记录（IPv4 地址，如 192.0.0.170, 192.0.0.171）；
所以你向“正常的 DNS 服务器”发出 AAAA 查询时，应该返回的是 No AAAA record。
只有当启用了 DNS64 功能，才可能收到“假的” AAAA 响应


如果设备是双栈（IPv4 + IPv6），而 DNS 服务器启用了 DNS64，那么：
对 ipv4only.arpa 做 DNS 查询时，是否可以同时解析出 IPv4 和 IPv6 地址？
不会同时得到 IPv4 和 IPv6 地址。
即使 DNS 支持 DNS64，双栈设备也不会触发 DNS64 的“合成 AAAA”机制。
DNS64 的工作前提：
###
DNS64 是为了解决IPv6-only 网络中“访问 IPv4-only 域名”的问题。
###
它的典型触发流程是：
设备是 IPv6-only（没有 IPv4 栈）
应用调用 getaddrinfo(domain, AF_UNSPEC)
DNS64 收到 AAAA 查询
如果目标域名无 AAAA、有 A，则：
DNS64 用 NAT64 前缀 + A 地址 → 合成一个伪 AAAA
返回给设备，设备用 IPv6 栈去连接 NAT64 地址
如果是双栈设备呢？
设备有 IPv4 栈 → 可以直接处理 A 记录 → 不会依赖 DNS64
操作系统或 DNS 客户端库（如 getaddrinfo）：
默认优先信任 A 记录结果
不会请求 DNS64 合成 AAAA


解析 ipv4only.arpa 
getaddrinfo("ipv4only.arpa", ...)
这相当于在让操作系统查询 DNS 服务器，问：
“ipv4only.arpa 这个域名的 IP 地址是多少？”
也就是 发起一个 DNS 查询请求，目标是解析出该域名的 IP 地址（IPv4 或 IPv6）。

它是一个特殊测试域名，只有 IPv4 地址（A 记录），没有原生 AAAA 记录；
如果你设备是 IPv6-only，正常是无法查询到这个 A 记录的（因为不能访问 IPv4 DNS 服务器）；
除非 DNS 服务器启用了 DNS64，它会伪造一个 AAAA 记录，返回给你设备。

返回内容	网络判断	说明
返回 IPv4 地址（A 记录）	✅ 不是 NAT64 网络	当前网络支持 IPv4，或是双栈；系统可以直接访问 IPv4，不需要 NAT64
返回 IPv6 地址（伪造的 AAAA 记录）	✅ 是 NAT64 网络	当前网络是 IPv6-only，DNS 启用了 DNS64，用来支持 NAT64 访问

如果你设备处于双栈网络（IPv4 + IPv6），访问 ipv4only.arpa 时，你只能获得 IPv4 地址（A 记录），不会得到 IPv6 地址（AAAA 记录）。

尝试获取系统 DNS 对 ipv4only.arpa 的解析结果:
“系统 DNS”指的是你当前设备或系统配置使用的 DNS 服务器
向你当前设备所配置的 DNS 服务器发送一个查询 ipv4only.arpa 的请求，然后返回其解析结果（可能是 IPv6，也可能是 IPv4，也可能为空）。
为什么选择 ipv4only.arpa？
这是一个特殊域名，用来检测 是否启用了 DNS64（伪造 IPv6 地址）。// 是否启用了 DNS64: 你当前设备所配置的 DNS 服务器是否支持并启用了 DNS64 功能.你是通过向“系统配置的 DNS 服务器”请求解析 ipv4only.arpa，来判断这个 DNS 服务器是否有 DNS64 功能。
正常情况下这个域名只有 A 记录（IPv4），没有 AAAA 记录（IPv6）；
如果你当前网络启用了 DNS64，那么系统 DNS 会“伪造”出一个 IPv6 地址返回；
你就可以根据这个返回结果判断是否在 NAT64 网络中。


==================================================DNS64 和 NAT64
DNS64 和 NAT64 是一对 合作使用的网络协议机制，目的是：
✅ 让 IPv6-only 设备 能够无感访问 仅支持 IPv4 的服务器。

DNS64 是“伪造 IPv6 地址”，NAT64 是“把伪造的 IPv6 地址转换成真实 IPv4 通信”。

模块	作用	举例
DNS64	把 IPv4-only 的域名伪造一个 IPv6 地址（合成 AAAA 记录）返回给客户端	example.com → 64:ff9b::5d:b8:d8:22
NAT64	把客户端发往这个“伪造 IPv6 地址”的请求，实际转发给对应的 IPv4 地址	64:ff9b::5d:b8:d8:22 → 93.184.216.34


NAT64 网关 可以是：
✅ 一个独立的网络设备（如路由器、防火墙）；
✅ 或者部署在某台服务器上的软件服务；
✅ 有时甚至是操作系统内核自带的功能（如 iOS / Android 的 tethering）；
具体取决于谁在管理 NAT64 网络，以及它部署在哪一层。


==================================================
“公网”就是“公共网络”的简称，简单来说就是可以直接通过互联网访问的网络。

公网 IP 地址是全球唯一的，任何地方的设备都能通过互联网访问这个地址；

特点	公网 IP	私网 IP（局域网 IP）
地址范围	全球唯一	只能在局域网内使用，如 192.168.x.x、10.x.x.x、172.16.x.x ~ 172.31.x.x
访问方式	直接通过互联网访问	不能直接被互联网访问，需 NAT 转换
举例	你的服务器 IP、手机外网 IP	家里路由器分配给你电脑或手机的 IP