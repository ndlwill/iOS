http://www.52im.net/topic-tcpipvol1.html?mobile=no

TCP/IP（传输控制协议/网间协议）是一种网络通信协议
TCP/IP是INTERNET的基础协议，也是一种电脑数据打包和寻址的标准方法

######
在数据传送中，可以形象地理解为有两个信封，TCP和IP就像是信封，要传递的信息被划分成若干段，每一段塞入一个TCP信封，并在该信封面上记录有分段号的信息，再将TCP信封塞入IP大信封，发送上网

在接受端，一个TCP软件包收集信封，按发送前的顺序还原，抽出数据并加以校验，若发现差错，TCP将会要求重发

TCP/IP在INTERNET中几乎可以无差错地传送数据

协议是为了在两台计算机之间交换数据而预先规定的标准

TCP/IP并不是一个而是许多协议,它代表一个协议集,而TCP和IP只是其中两个基本协议而已

TCP将数据流分成小段叫做TCP数据段（TCP segments），并利用IP协议进行传输.

在大多数情况下，每个TCP数据段装在一个IP数据报中进行发送。但如需要的话，TCP将把数据段分成多个数据报，而IP数据报则与同一网络不同主机间传输位流和字节流的物理数据帧相容。由于IP并不能保证接收的数据报的顺序相一致，TCP会在收信端装配TCP数据段并形成一个不间断的数据流

(一种最好的了解TCP/IP工作实质的方法，是使用探测程序来观察网络中的到处流动的帧中被不同TCP/IP模块所加上的信息)

######
当使用HTTP(超文本传输协议)的Web浏览器从连接在Internet上的Web服务器上获取一页HTML数据时所发生的情况。为形成同Web服务器的虚链路，浏览器使用一种被抽象地称为套接口(socket)的高层软件。为了获取Web页，它通过向套接口向套接口写入HTTPGET命令来向Web服务器发出该指令。接下来套接口软件使用TCP协议向Web服务器发出包含GET命令的字节流和位流，TCP将数据分段并将各独立段传到IP模块，该模块将数据段转换成数据报并发送给Web服务器

如果浏览器和服务器运--在不同物理网络的计算机上(一般情况如此)，数据报从一个网络传到另一个网络，直到抵达服务器所在的那个网。最终，数据被传输到目的地址并被重新装配，这样Web服务器通过读自己的套接口来获得数据主干，并进而查看连续的数据流。对浏览器和服务器来说，数据在这一端写入套接口而在另一端出现如同魔术一般，但这只是底下发生的各种复杂的交互，它创造了数据经过网络无缝传输的假象

尽管通过 I P 地 址 可 以 识 别 主 机 上 的 网 络 接 口 , 进 而 访 问 主 机 , 但 是 人 们 最 喜 欢 使 用 的 还是主机名。在 T C P / I P 领域中,域名系统( D N S )是一个分布的数据库,由它来提供 I P 地址和主机名之间的映射信息

当应用程序用 T C P 传 送 数 据 时 , 数 据 被 送 入 协 议 栈 中 , 然 后 逐 个 通 过 每 一 层 直 到 被 当 作一串比特流送入网络

TCP 传给 I P 的 数 据 单 元 称 作 T C P 报 文 段 或 简 称 为 T C P 段( T C Ps e g m e n t )。 I P 传给网络接口层的数据单元称作 I P 数据报 ( I P d a t a g r a m ) 。 通 过 以 太 网 传 输 的 比 特流称作帧 (F r a m e ) 。

由于 T C P 、 U D P 、 I C M P 和 I G M P 都要向 I P 传 送 数 据 , 因 此 I P 必须在生成的 I P 首 部 中 加 入 某 种 标 识 , 以 表 明 数 据 属 于 哪 一 层。为 此 , I P 在 首 部 中 存 入 一 个 长 度 为8 b i t 的 数 值 , 称 作 协 议 域 。 1 表示为 I C M P 协议, 2表示为 I G M P 协议, 6 表示为 T C P 协议, 1 7 表示为 U D P 协议

类似地,许多应用程序都可以使用 T C P 或 U D P 来 传 送 数 据 。 运 输 层 协 议 在 生 成 报 文 首 部时 要 存 入 一 个 应 用 程 序 的 标 识 符 。 T C P 和 U D P 都用一个 1 6 b i t 的 端 口 号 来 表 示 不 同 的 应 用 程 序 。T C P 和 U D P 把源端口号和目的端口号分别存入报文首部中

网络接口分别要发送和接收 I P 、 A R P和 R A R P 某种形式的标识,以指明生成数据的网络层协议。为此,以太网的帧首部也有一个 16 bit的数 据 , 因 此 也 必 须 在 以 太 网 的 帧 首 部 中 加 入类型域

=========================数据分用
当目的主机收到一个以太网数据帧时,数据就开始从协议栈中由底向上升,同时去掉各层协议加上的报文首部。每层协议盒都要去检查报文首部中的协议标识,以确定接收数据的上 层 协 议 。 这 个 过 程 称 作 分 用 ( D e m u l t i p l e x i n g ) 

协议 I C M P 和 I G M P 定位一直是一件很棘手的事情。它们与 I P 放在同一层上,那是因为事实上它们是IP的附属协议。但是在这里,我们又把它们放在 I P 层的上面,这是因为ICMP和IGMP报文都被封装在IP数据报中

对于 A R P 和R A R P 。 在 这 里 把 它 们 放 在 以 太 网 设 备 驱 动 程序的上方,这是因为它们和 I P 数据报一样,都有各自的以太网数据帧类型


=========================客户-服务器模型
大部分网络应用程序在编写时都假设一端是客户,另一端是服务器,其目的是为了让服务器为客户提供一些特定的服务。

可以将这种服务分为两种类型:重复型或并发型。

重复型服务器通过以下步骤进行交互: 
I1.  等待一个客户请求的到来。
I2.  处理客户请求。
I3.  发送响应给发送请求的客户。
I4.  返回 I 1 步。
重复型服务器主要的问题发生在 I 2状 态 。 在 这 个 时 候 , 它 不 能 为 其 他 客 户 机 提 供 服 务 

并发型服务器采用以下步骤:   
C1. 等待一个客户请求的到来。
C2. 启动一个新的服务器来处理这个客户的请求。在这期间可能生成一个新的进程、任务或线程,并依赖底层操作系统的支持。这个步骤如何进行取决于操作系统。生成的新服务器对客户的全部请求进行处理。处理结束后,终止这个新服务器。
C3. 返回 C 1 步。

并发服务器的优点在于它是利用生成其他服务器的方法来处理客户的请求。也就是说,每个客户都有它自己对应的服务器。如果操作系统允许多任务,那么就可以同时为多个客户服务。 

一般来说, T C P 服务器是并发的,而 U D P 服 务 器 是 重 复 的 , 但 也 存 在 一 些 例 外 。

=========================
tcp/ip协议分为七层。但是一般而言我们吧应用层，会话层，表达层归为一层
最下面是物理层，它代表着进行数据转输的物理介质，换句话说，即网络电缆
其上是数据链路层，它通过网络接口卡提供服务
最上层是应用层，这里运行着使用网络服务的应用程序

###
链路层,有时也称作数据链路层或网络接口层
通常包括操作系统中的设备驱动程序和计算机中对应的网络接口卡。

以太网协议：
以太网规定，一组电信号构成一个数据包，叫做"帧"（Frame）。每一帧分成两个部分：标头（Head）和数据（Data）
"标头"的长度，固定为18字节。"数据"的长度，最短为46字节，最长为1500字节。因此，整个"帧"最短为64字节，最长为1518字节。如果数据很长，就必须分割成多个帧进行发送
以太网规定，连入网络的所有设备，都必须具有"网卡"接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。

每块网卡出厂的时候，都有一个全世界独一无二的MAC地址，长度是48个二进制位，通常用12个十六进制数表示
前6个十六进制数是厂商编号，后6个是该厂商的网卡流水号。有了MAC地址，就可以定位网卡和数据包的路径了

一块网卡怎么会知道另一块网卡的MAC地址？
回答是有一种ARP协议
以太网数据包必须知道接收方的MAC地址，然后才能发送。

以太网数据包只包含MAC地址

广播
就算有了MAC地址，系统怎样才能把数据包准确送到接收方？
它不是把数据包准确送到接收方，而是向本网络内所有计算机发送，让每台计算机自己判断，是否为接收方。
1号计算机向2号计算机发送一个数据包，同一个子网络的3号、4号、5号计算机都会收到这个包。它们读取这个包的"标头"，找到接收方的MAC地址，然后与自身的MAC地址相比较，如果两者相同，就接受这个包，做进一步处理，否则就丢弃这个包。这种发送方式就叫做"广播"（broadcasting）

以太网采用广播方式发送数据包，所有成员人手一"包"，不仅效率低，而且局限在发送者所在的子网络。也就是说，如果两台计算机不在同一个子网络，广播是传不过去的。

互联网是无数子网络共同组成的一个巨型网络

如果两台电脑不在同一个子网络，就无法知道对方的MAC地址，必须通过网关（gateway）转发
1号电脑要向4号电脑发送一个数据包。它先判断4号电脑是否在同一个子网络，结果发现不是（后文介绍判断方法），于是就把这个数据包发到网关A。网关A通过路由协议，发现4号电脑位于子网络B，又把数据包发给网关B，网关B再转发到4号电脑

###
网络层
它的作用是引进一套新的地址，使得我们能够区分不同的计算机是否属于同一个子网络。这套地址就叫做"网络地址"，简称"网址"。
"网络层"出现以后，每台计算机有了两种地址，一种是MAC地址，另一种是网络地址
两种地址之间没有任何联系，MAC地址是绑定在网卡上的，网络地址则是管理员分配的，它们只是随机组合在一起
网络地址帮助我们确定计算机所在的子网络，MAC地址则将数据包送到该子网络中的目标网卡

IPv4这个版本规定，网络地址由32个二进制位组成：
用分成四段的十进制数表示IP地址，从0.0.0.0一直到255.255.255.255

规定网络地址的协议，叫做IP协议。它所定义的地址，就被称为IP地址
这个地址分成两个部分，前一部分代表网络，后一部分代表主机。比如，IP地址172.16.254.1，这是一个32位的地址，假定它的网络部分是前24位（172.16.254），那么主机部分就是后8位（最后的那个1）
处于同一个子网络的电脑，它们IP地址的网络部分必定是相同的，也就是说172.16.254.2应该与172.16.254.1处在同一个子网络

问题在于单单从IP地址，我们无法判断网络部分。还是以172.16.254.1为例，它的网络部分，到底是前24位，还是前16位，甚至前28位，从IP地址上是看不出来的
怎样才能从IP地址，判断两台计算机是否属于同一个子网络呢？这就要用到另一个参数"子网掩码"（subnet mask）

所谓"子网掩码"，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。比如，IP地址172.16.254.1，如果已知网络部分是前24位，主机部分是后8位，那么子网络掩码就是11111111.11111111.11111111.00000000，写成十进制就是255.255.255.0

知道"子网掩码"，我们就能判断，任意两个IP地址是否处在同一个子网络。方法是将两个IP地址与子网掩码分别进行AND运算（两个数位都为1，运算结果为1，否则为0），然后比较结果是否相同，如果是的话，就表明它们在同一个子网络中，否则就不是

比如，已知IP地址172.16.254.1和172.16.254.233的子网掩码都是255.255.255.0，请问它们是否在同一个子网络？两者与子网掩码分别进行AND运算，结果都是172.16.254.0，因此它们在同一个子网络

IP协议的作用主要有两个，一个是为每一台计算机分配IP地址，另一个是确定哪些地址在同一个子网络

根据IP协议发送的数据，就叫做IP数据包
IP数据包也分为"标头"和"数据"两个部分：
"标头"部分主要包括版本、长度、IP地址等信息，"数据"部分则是IP数据包的具体内容

IP数据包的"标头"部分的长度为20到60字节，整个数据包的总长度最大为65,535字节。因此，理论上，一个IP数据包的"数据"部分，最长为65,515字节。前面说过，以太网数据包的"数据"部分，最长只有1500字节。因此，如果IP数据包超过了1500字节，它就需要分割成几个以太网数据包，分开发送了

我们可以把IP数据包直接放进以太网数据包的"数据"部分，因此完全不用修改以太网的规格。这就是互联网分层结构的好处：上层的变动完全不涉及下层的结构。

###
运输层主要为两台主机上的应用程序提供端到端的通信
有 两 个互 不 相 同 的 传 输 协 议 : T C P ( 传 输 控 制 协 议 ) 和 U D P ( 用 户 数 据 报 协 议 )
T C P 为两台主机提供高可靠性的数据通信。它所做的工作包括把应用程序交给它的数据分成合适的小块交给下面的网络层,确认接收到的分组,设置发送最后确认分组的超时时钟等。由于运输层提供了高可靠性的端到端的通信,因此应用层可以忽略所有这些细节。


在 T C P / I P 协议族中,网络层 I P 提 供 的 是 一 种 不 可 靠 的 服 务 。 也 就 是 说 , 它 只 是 尽 可 能 快地把分组从源结点送到目的结点,但是并不提供任何可靠性保证。而另一方面, T C P 在不可靠的 I P 层 上 提 供 了 一 个 可 靠 的 运 输 层 。 为 了 提 供 这 种 可 靠 的 服 务 , T C P 采 用 了 超 时 重 传 、 发送和接收端到端的确认分组等机制。由此可见,运输层和网络层分别负责不同的功能