IP地址是网络世界里的门牌号。你可以通过IP地址访问远在天边的网站,那么数据是如何到达网站的呢？靠的就是路径上每个节点的路由。 
路由，简单的说就是指导IP报文该去哪的指示牌。

主机会在以下两个时机进行路由查询:
收到报文时，查询路由决定是上送本机(LOCAL IN)，或者从哪个出接口转发(FORWARD)
本机发送报文时，查询报文出接口

路由表:
一个外部网卡eth0和一个内部还回网卡lo

eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:51  
          inet addr:192.168.99.35  Bcast:192.168.99.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:27849718 errors:1 dropped:0 overruns:0 frame:0
          TX packets:29968044 errors:5 dropped:0 overruns:2 carrier:3
          collisions:0 txqueuelen:100 
          RX bytes:943447653 (899.7 Mb)  TX bytes:2599122310 (2478.7 Mb)
          Interrupt:9 Base address:0x1000 

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:7028982 errors:0 dropped:0 overruns:0 frame:0
          TX packets:7028982 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:1206918001 (1151.0 Mb)  TX bytes:1206918001 (1151.0 Mb)

[root@tristan]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0

如果报文的目的IP地址在192.168.99.0/24这个网段，那么它应该从eth0进行转发
如果报文的目的IP地址在127.0.0.1/8这个网段，那么它应该从lo进行转发
其他情况下(0.0.0.0/0)，报文从eth0转发，下一跳IP地址是192.168.99.254

主机之间通过交换机组成一个小型局域网，再通过一个路由器连接到更大的网络。
图中的路由器对于局域网内的主机来说，即可称为Gateway，一般翻译为网关。
他的地位如同一个国家的海关,出了海关，IP报文就在另一个网络之中了。
路由表的第3条，当主机发现报文的目的IP地址不满足其他表项时，就表示这个报文需要送到局域网外部，所以它会将报文发送或者转发给网关，也就是192.168.99.254。
这种情况下，192.168.99.254被称为默认网关，这条表项也称为默认路由。与这个名字对应的，第1,2条路由表项也被称为网段路由

局域网内部通信:
当我们为网卡配置IP地址时或者由DHCP服务器分配IP地址，Linux内核会根据IP地址和掩码自动生成对应的网段路由。
这相当于告诉系统，这个网段的主机在同一个局域网内部

假设我们在tristan主机去ping局域网内的susan主机。那么这个ICMP request报文向下面这样组装
DMAC    SMAC    DIP     SIP
susan_mac   tristan_mac     192.168.99.33   192.168.99.35
如果 tristan还不知道susan主机上eth0的MAC地址，那么它首先要发送ARP广播报文去获得。

局域网外通信:
与局域网外的主机通信就需要通过(via)网关了
假设我们在tristan主机去ping局域网外的paul主机的eth0, 在查询路由后，内核选择默认网关，那么组装的ICMP request的报文头将是下面这样
DMAC    SMAC    DIP     SIP
paul_mac   route1_if0_mac     192.168.100.57   192.168.99.35

tristan主机要与jerry主机所在的网络通信，显然根据现有的路由表，显然是不行的。因此我们需要在tristan主机上配置额外的路由表项:
route add -net 192.168.98.0 netmask 255.255.255.0 gw 192.168.99.1

192.168.98.0    192.168.99.1    255.255.255.0   UG    0      0        0 eth0

新添加的路由表项表示本机与192.168.98.0/24范围内的主机主机通信，需要途径网关192.168.99.1


主机路由:
除了设置整个网段，我们还可以仅为某个目的IP设置路由,即主机路由
主机路由实际上这是掩码为255.255.255.255的网段路由的特殊形式
route add -host 192.168.98.42 gw 192.168.99.1
或者
route add -net 192.168.98.42 netmask 255.255.255.255 gw 192.168.99.1
都可以生成一条特定主机的路由，Flags字段中的H表示Host

Flags中U表示Up、G表示GateWay，H表示Host

我们的目标地址是103.235.46.39，与路由表里面每一条路由的掩码（Genmask）做按位与（全1为1，有0则0）运算
103.235.46.39 & 255.255.255.0 = 103.235.46.0
103.235.46.39 & 0.0.0.0       = 0.0.0.0
在和路由表里面的目标地址（Destination）比较,满足要求，就直接把数据包扔给网关（Gateway）.然后就不管了，这个过程我们叫下一跳

==================================================
一个数据包的整体流程为：应用程序需要发起连接请求后开始阻塞-->>传数控制层发起握手包后开始阻塞-->>网络层寻找下一跳后开始阻塞-->>链路层一看有没有目标下一跳的mac地址，没有mac地址则先发ARP广播请求MAC，得到MAC后开始阻塞-->>物理层实际来发送

路由器寻址过程:
数据包格式[源IP-->>目标IP;源MAC-->>目标MAC ]，例：192.168.1.2 要发数据包给 192.168.2.3

ARP解析过程（没有MAC地址的情况下）
根据192.168.1.2的路由表找到下一跳192.168.1.1（路由器）
192.168.1.2 发送数据包给交换机，MAC地址为全f，交换机广播给192.168.1.3和192.168.1.1，封数据包[192.168.1.2-->>192.168.2.3;下一跳192.168.1.1;MAC@192.168.1.2-->>全f ]
192.168.1.3一看下一跳IP为192.168.1.1，不是自己的，丢弃此包
192.168.1.1一看下一跳IP为192.168.1.1，是自己的，封包返回自己的mac地址，封数据包[192.168.1.1-->>192.168.1.2;MAC@192.168.1.1-->>MAC@192.168.1.2 ]
192.168.1.2得知路由器192.168.1.1的mac地址

实际上以上过程在网线刚插上电脑的时候就会发生（设备加入网络的时候就会发生，无论通过网线还是WIFI），相当于告诉局域网里内的所有主机
请记住我的MAC地址！

交换机:
交换机是有很多端口的（插网线的物理的端口），一个端口对应一台主机，当第一个ARP包从主机192.168.1.2发出来的时候交换机就记住了该端口的MAC地址
ARP从路由器192.168.1.1返回的时候其实直接从交换机的该端口返回给了192.168.1.2

其实TCP/IP协议中所谓的端口是逻辑上的，你的主机65536个端口并没有65536个网线接口，而是在协议上面逻辑划分的，用来区分不同的进程！

数据包发送过程:
通过ARP协议得到了MAC地址之后才能进行实际的数据包发送
根据192.168.1.2的路由表找到下一跳192.168.1.1（路由器）
192.168.1.2 发送数据包给交换机，交换机发给路由器，封数据包[192.168.1.2-->>192.168.2.3;下一跳192.168.1.1;MAC@192.168.1.2-->>MAC@192.168.1.1 ]
路由器上面连着俩网卡，一边是192.168.1.0网络，另外一边是192.168.2.0这个网络，那么它的路由表里面就一定有一条记录能找到192.168.2.0这个网络
路由器一看是192.168.2.3，把数据包交给交换机，交换机在根据MAC地址找到192.168.2.3并把数据包交给它

总结
交换机不需要IP，只需要MAC地址，是连着同一局域网的
路由器需要IP和MAC，是连接着不同局域网的
192.167.1.0和192.168.2.0是网络号，表示两个不同的网络（子网）
