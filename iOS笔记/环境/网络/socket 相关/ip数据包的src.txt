在电脑本地（发送端）生成的 IP 包:
当你的电脑（IP：192.168.0.100）通过 Wi-Fi 连接到路由器并发出一个 Socket 数据包时：
操作系统的 TCP/IP 栈生成的 IP 包的源地址（src）是
192.168.0.100
目标地址（dst）是
你要通信的服务器，比如 142.250.183.78:443（Google）。
所以，在电脑上抓包（例如用 Wireshark 抓 Wi-Fi 接口）看到的源地址一定是 192.168.0.100。


当数据包经过 NAT（路由器）时:
家庭 Wi-Fi 路由器通常执行 NAT（网络地址转换）。
当该 IP 包离开路由器、发送到互联网时，路由器会修改包头：
| 字段            | 变化                                              |
| ------------- | ----------------------------------------------- |
| 源 IP (`src`)  | 从 `192.168.0.100` → **公网 IP（例如 `203.0.113.5`）** |
| 源端口           | 一般也会做端口转换（PAT），例如 `54321` → `61023`             |
| 目标 IP (`dst`) | 不变（仍是服务器的公网 IP）                                 |
这时，发送到公网的 外层 IP 包 的源地址是：// #####这边的外层 IP 包不是再包一层新的 IP 头，在 NAT 的场景里，根本不存在“外层 IP 包”，只有同一个 IP 包被修改后转发。这边只是说明： 单个ip包 就是 外层 IP 包，是同一个包#####
203.0.113.5（你的路由器的公网 IP）


服务器端看到的源地址:
远程服务器收到的 TCP/IP 包里：
    源地址是：203.0.113.5
    目标地址是：服务器自己的公网地址
所以服务器看到的你，就是你的 NAT 后的公网 IP。


NAT 映射表的作用
路由器内部维护一张 NAT 映射表，例如：
| 内网源 IP:端口           | 公网源 IP:端口         | 目标 IP:端口           |
| ------------------- | ----------------- | ------------------ |
| 192.168.0.100:54321 | 203.0.113.5:61023 | 142.250.183.78:443 |
这样当服务器响应时，路由器根据表项找到对应的内网主机，把包再改回：
dst 从 203.0.113.5 → 192.168.0.100
dst port 从 61023 → 54321
再转发回电脑。


#####
NAT 是“修改（rewrite）”，不是“封装（encapsulation）”

当家庭路由器执行 NAT（Network Address Translation）时，它的行为是：
在转发过程中直接修改 IP 包头字段（in-place rewrite）
并不是在原包外面再包一层新的 IP 头。
#####


“外层 IP 包”这个说法在哪种情况下才成立？
这个说法其实属于 “隧道封装（tunneling）”，例如：
| 场景                 | 是否“包了一层新的 IP 头” | 示例                                      |
| ------------------ | --------------- | --------------------------------------- |
| NAT                | ❌ 否，仅修改         | 家用路由器                                   |
| VPN                | ✅ 是，封装一层外层 IP   | iOS Packet Tunnel / OpenVPN / WireGuard |
| GRE / IPsec Tunnel | ✅ 是             | 企业路由器、云隧道                               |


NAT vs 封装
| 特性         | NAT    | VPN/IPsec/GRE |
| ---------- | ------ | ------------- |
| 是否生成新 IP 头 | ❌ 否    | ✅ 是           |
| 包结构        | 原包被修改  | 原包被“包起来”      |
| 路由器行为      | 改包头、转发 | 封装、发送         |
| 目的         | 地址转换   | 隧道传输、加密、隔离    |
