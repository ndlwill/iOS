enum BindResolvers {

  static func getServers() -> [String] {
    // 1. Manually allocate memory for one __res_9_state struct. On iOS 17 and below, this prevents the linker
    // from attempting to link to libresolv9 which prevents an "Symbol not found" error.
    // See https://github.com/firezone/firezone/issues/10108
    let statePtr = UnsafeMutablePointer<__res_9_state>.allocate(capacity: 1)
    statePtr.initialize(to: __res_9_state())  // Zero-initialize the allocated memory.

    // 2. Ensure memory is cleaned up.
    defer {
      res_9_ndestroy(statePtr)
      statePtr.deinitialize(count: 1)
      statePtr.deallocate()
    }

    // 3. Initialize the resolver state by passing the pointer directly.
    guard res_9_ninit(statePtr) == 0 else {
//      Log.warning("Failed to initialize resolver state")

      // Cleanup will happen via defer.
      return []
    }

    // 4. Get the servers.
    var servers = [res_9_sockaddr_union](repeating: res_9_sockaddr_union(), count: 10)
    let foundCount = Int(res_9_getservers(statePtr, &servers, Int32(servers.count)))

    // 5. Process the results.
    let validServers = Array(servers[0..<foundCount]).filter { $0.sin.sin_len > 0 }
    return validServers.map { getnameinfo($0) }
  }

  private static func getnameinfo(_ sock: res_9_sockaddr_union) -> String {
    var sockUnion = sock
    var hostBuffer = [CChar](repeating: 0, count: Int(NI_MAXHOST))
    let sinlen = socklen_t(sockUnion.sin.sin_len) // Works for both IPv4 and IPv6

    _ = withUnsafePointer(to: &sockUnion) {
      $0.withMemoryRebound(to: sockaddr.self, capacity: 1) {
        Darwin.getnameinfo(
          $0, sinlen,
          &hostBuffer, socklen_t(hostBuffer.count),
          nil, 0,
          NI_NUMERICHOST)
      }
    }
    return String(cString: hostBuffer)
  }
}


BSD 网络协议栈（包括 Darwin）中：
struct sockaddr 是所有 socket 地址的通用头部结构；
每个协议族（IPv4 / IPv6 / Unix domain）都在开头复用相同的两个字段：
uint8_t sa_len;
sa_family_t sa_family;
所以任何地址都可以安全地强制转换为 struct sockaddr *，而不会破坏前两个字段。
这就是为什么：
(struct sockaddr *)&sockUnion.sin6
和
(struct sockaddr *)&sockUnion.sin
都能正确地让 getnameinfo() 识别协议族与长度。