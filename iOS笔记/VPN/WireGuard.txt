https://www.wireguard.com/

https://git.zx2c4.com/wireguard-apple/about/

WireGuard 是一种 VPN 协议，也是一个开源的 VPN 实现
协议：WireGuard 定义了一套加密和通信规则，用于在两个或多个节点之间建立安全的点对点连接。


与传统 VPN 的对比
| 协议        | 特点                         |
| --------- | -------------------------- |
| OpenVPN   | TLS + UDP/TCP，可穿透 NAT，配置复杂 |
| IPSec     | 标准协议，企业支持广，性能一般            |
| WireGuard | 高性能、现代加密、轻量、易维护            |
WireGuard 是 新一代 VPN 协议，目标是更快、更安全、更简单


安全内网穿透:
内网穿透 是指把位于内网（NAT / 防火墙后面、没有公网 IP）的主机或服务，安全地暴露给公网或远端客户端访问的技术。
加上“安全”二字，强调在穿透过程中保证认证、授权与数据加密，避免被未授权访问或中间人攻击。
举例：你家里/公司内网的某台服务器（192.168.x.x）想让外网的同事、手机或 CI 访问，但这台机器没有公网 IP，也不想把整个网络暴露，这时就需要内网穿透。


加密隧道（Encrypted Tunnel）指的是:
对客户端虚拟网卡拦截到的网络流量进行 封装和加密，然后通过公网传输，远端服务器再解封、解密并转发到目标网络。
换句话说，它把你的数据包包装起来，外面套一层加密“管道”，在公网中传输时别人看不到真实内容，也无法篡改。


==================================================“通过 UDP NAT 打洞”是理解 WireGuard 穿透能力的关键之一
NAT（Network Address Translation，网络地址转换）通常是路由器或操作系统内置的功能

NAT 的作用
隐藏内网 IP：内网设备不直接暴露公网地址
共享公网 IP：多台设备共用一个公网 IP 上网
端口映射：允许外部访问内网特定服务（端口转发）

1. 先理解 NAT（网络地址转换）
多数设备都在 内网（私有 IP） 中，没有公网 IP。
路由器通过 NAT（Network Address Translation） 把多个内网设备共享一个公网 IP。

比如：
内网设备 A: 192.168.1.10
内网设备 B: 192.168.1.20
路由器公网 IP: 100.100.100.5

当 A 发出一个 UDP 包时：
源地址: 192.168.1.10:54321
目标地址: 8.8.8.8:53

路由器会在转发时做转换：
改成: 源地址 100.100.100.5:40001 → 目标地址 8.8.8.8:53
并在 NAT 表里记录映射：
(100.100.100.5:40001) ↔ (192.168.1.10:54321)
这样返回包就能找到对应的内网主机。

2. NAT 的问题
因为 NAT 会“屏蔽”内网设备，没有外部请求主动连进来。
也就是说：
内网机器无法直接接受来自外部的连接（因为它没有公网 IP）。

3. 什么是“打洞”（Hole Punching）
打洞（hole punching） 指的是：
两个都在 NAT 后面的设备，借助一个“中间服务器（信令服务器）”，让它们之间也能直接通信。

它的核心思想是：
双方几乎同时向对方的公网地址发送 UDP 包，让 NAT 设备“认为”这是会话的一部分，从而允许后续双向通信。



UDP 打洞流程（简化）
假设两台机器：
A：在内网 192.168.1.10，NAT 后公网映射 100.100.100.5:40001
B：在内网 10.0.0.5，NAT 后公网映射 200.200.200.6:50002
S：中继/信令服务器（有公网 IP）

流程：
1️⃣ 两者先各自与 S 通信，汇报自己的公网地址（100.100.100.5:40001、200.200.200.6:50002）。
2️⃣ S 把 A、B 的地址互相告诉对方。
3️⃣ A 向 B 的公网地址发 UDP 包；B 也向 A 的公网地址发 UDP 包。
4️⃣ 各自路由器 NAT 表中出现了对方的映射条目，于是后续 UDP 包就能直接互通。

这就叫“打洞”：在 NAT 的防火墙上为双方“打出一个洞”允许数据通过。


4. WireGuard 的 UDP NAT 打洞:
WireGuard 默认使用 UDP 协议 建立隧道（不像 OpenVPN 可以走 TCP）。
当客户端连接服务器时，双方通过 握手数据包（Handshake） 建立 NAT 映射。
WireGuard 的实现非常聪明：
    客户端定期发送 Keepalive 包（维持 NAT 映射）
    如果双方都在 NAT 后，也可以借助中继服务器（或配置 PersistentKeepalive）实现双向打洞。
一旦映射存在，双方就能 点对点通信，后续的加密隧道数据就可以直接通过。


5. 为什么 UDP 更适合打洞
UDP 是“无连接”的：可以随时发包，不需握手。
NAT 设备容易建立短期映射，只要双方同时发包就能穿透。
TCP 则需要三次握手，难以做到对称穿透（因此 OpenVPN TCP 模式常需要中继服务器）。



WireGuard 的“通过 UDP NAT 打洞”指的是：
即使客户端和服务器（你自己部署的 WireGuard 服务端）都处于 NAT / 防火墙后，只要能发出 UDP 数据包，
WireGuard 就可以借助 NAT 映射机制，使双方通过公网直接建立加密隧道通信，
而无需额外的端口映射或中继服务器。


通常情况下：
客户端（Client）在家用路由器或公司网络后面 → 有 NAT（私网 IP）
服务器（Server）在公网 → 有公网 IP
在这种情况下，客户端可以很容易连接服务器，因为公网 IP 是可达的。
👉 不需要打洞。

那么 “通过 UDP NAT 打洞” 是什么时候有用？
有时两端都不在公网，比如：
你在家（NAT 后面）
你的 VPN 服务器部署在另一个 NAT 网络里（例如云厂商容器环境、内网主机）
这时：
双方都没有公网 IP
理论上谁也发不出直连请求（都被各自 NAT 隔离）


UDP NAT 打洞（UDP Hole Punching）
就是通过双方都主动发送 UDP 包，利用 NAT 暂时为每个方向建立的“映射”，从而让两端能直接通信。
这个技术常用于：
WireGuard
WebRTC
P2P 传输（如 BitTorrent）


WireGuard 为什么能打洞？
WireGuard 是纯 UDP 协议。
客户端和服务端会周期性地发送 keepalive 包，保持 NAT 映射。
如果双方都发送探测包（并且 NAT 类型允许），连接可以在两边 NAT 后面建立“隧道”。


==================================================什么是中继服务器（Relay Server）？
中继服务器（relay server，也叫 TURN server 或 relay node）的作用就是：
➡️ 在 NAT 打洞失败时，帮助两端中转数据。
简单说，它是一个“中间代理”，用自己的公网 IP 把数据在两端之间转发。


为什么需要它？
因为并不是所有 NAT 都能被“打洞”：
有些企业或路由器防火墙配置得非常严格；
UDP 连接不能从外部建立；
或 NAT 会随机映射端口，不允许外部反向包。
这时：
A 无法直接发包到 B
B 也无法直接发包到 A
于是只能：
A → 发送数据给中继服务器；
B → 也连接到中继服务器；
中继服务器把 A 的数据转发给 B（反之亦然）。
这样虽然 增加了延迟与带宽消耗，但能保证连接成功。

中继服务器 是 NAT 穿透失败时的“兜底方案”，
它负责 中转加密后的 VPN 流量，让双方仍能通信。


| 类型               | 连接方式   | 是否需中继   |
| ---------------- | ------ | ------- |
| 家用 NAT ↔ 公网服务器   | ✅ 直接连  | 否       |
| 家用 NAT ↔ 公司 NAT  | ❌ 无法直连 | 是（需要中继） |
| 双方都能打洞（UDP 打洞成功） | ✅ P2P  | 否       |
| 双方 NAT 严格，打洞失败   | ❌      | 是（走中继）  |
