Intent çš„ perform() æœ¬èº«è§¦å‘ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œ
ç­‰ VPN çŠ¶æ€çœŸçš„å˜åŒ–ï¼ˆä¾‹å¦‚ connectedï¼‰ä¹‹åï¼Œ
å†è¿”å› IntentResult


ç”¨ AsyncSequence / Continuation ç­‰å¾…çŠ¶æ€å˜åŒ–


1. Continuation
final class VPNStateStore {

    private var continuations: [CheckedContinuation<VPNStatus, Never>] = []

// app åªè¦è®¾ç½® status å°±èƒ½å”¤é†’ Intent
    var status: VPNStatus = .disconnected {
        didSet {
            continuations.forEach { $0.resume(returning: status) }
            continuations.removeAll()
        }
    }

    func waitForStatus(_ target: VPNStatus) async {
        if status == target { return }

/*
withCheckedContinuation

å®ƒåšçš„äº‹æ˜¯ï¼š
æš‚åœå½“å‰ async å‡½æ•°
ç»™ä½ ä¸€ä¸ª contï¼ˆcontinuationï¼‰// cont ä¸ resumeï¼Œè¿™ä¸ª await å°±ä¼šä¸€ç›´å¡ç€ï¼ˆæ°¸è¿œä¸ä¼šè¿”å›ï¼‰
ä½ ä»¥ååœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨ cont.resume(...)
async å‡½æ•°å°±ä¼šä»è¿™é‡Œç»§ç»­å¾€ä¸‹æ‰§è¡Œ


æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼š
å½“å‰ async å‡½æ•° æš‚åœ
å½“å‰ Task æŒ‚èµ·
ç³»ç»ŸæŠŠæ§åˆ¶æƒè®©å‡ºå»ï¼ˆçº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼‰
æ­¤æ—¶ï¼š
å”¯ä¸€èƒ½è®©è¿™ä¸ª async å‡½æ•°ç»§ç»­çš„ä¸œè¥¿
ğŸ‘‰ å°±æ˜¯è¿™ä¸ª cont

âŒ ä¸æ˜¯ï¼š
çº¿ç¨‹é˜»å¡
æ­»å¾ªç¯
CPU å ç”¨
âœ… è€Œæ˜¯ï¼š
Task ä¸€ç›´å¤„äº suspended
await æ°¸è¿œç­‰ä¸åˆ°å®Œæˆä¿¡å·
*/
        await withCheckedContinuation { cont in
            continuations.append(cont)
        }
    }
}

struct ConnectVPNIntent: AppIntent {

    @Dependency
    var vpnService: VPNService

    @Dependency
    var vpnStateStore: VPNStateStore

    func perform() async throws -> some IntentResult {

        // 1. å‘èµ·è¿æ¥
        await vpnService.connect()

        // 2. ç­‰å¾…çŠ¶æ€å˜ä¸º connected
        await vpnStateStore.waitForStatus(.connected)

        // 3. è¿”å›ç»“æœ
        return .result(value: "VPN Connected")
    }
}

å¿…é¡»æ³¨æ„çš„ 3 ä¸ªç³»ç»Ÿçº§é™åˆ¶
1ï¸âƒ£ Intent ä¸èƒ½æ— é™ç­‰
ç³»ç»Ÿå¯¹ Intent æœ‰éšå¼æ—¶é—´é¢„æœŸ
2ï¸âƒ£ VPN è¿æ¥æ˜¯ã€Œç³»ç»Ÿå¼‚æ­¥æ“ä½œã€
å³ä½¿ä½  await çŠ¶æ€ï¼š
ç”¨æˆ·å¯èƒ½ç‚¹äº†ã€Œä¸å…è®¸ VPNã€
3ï¸âƒ£ ä¸è¦åœ¨ Intent é‡Œåšã€Œé•¿æœŸçŠ¶æ€ç®¡ç†ã€
Intent çš„èŒè´£æ˜¯ï¼š
å‘èµ·åŠ¨ä½œ + ç­‰ç»“æœ
ä¸æ˜¯ï¼š
å¸¸é©»ç›‘å¬


status æ”¹å˜
â†“
didSet
â†“
resume continuation



2. AsyncSequence
enum VPNStatus: Equatable {
    case disconnected
    case connecting
    case connected
    case disconnecting
}


actor VPNStateStore {

    private var status: VPNStatus = .disconnected
    private var continuation: AsyncStream<VPNStatus>.Continuation?

    func statusStream() -> AsyncStream<VPNStatus> {
        AsyncStream { continuation in
            self.continuation = continuation

            // ç«‹å³æŠŠå½“å‰çŠ¶æ€å‘å‡ºå»ï¼ˆå¾ˆå…³é”®ï¼‰
            continuation.yield(status)
        }
    }

    func updateStatus(_ newStatus: VPNStatus) {
        guard status != newStatus else { return }

        status = newStatus
        continuation?.yield(newStatus)
    }

    func currentStatus() -> VPNStatus {
        status
    }
}


func waitForConnected() async {
    let stream = await vpnStateStore.statusStream()

    for await status in stream {
        if status == .connected {
            return
        }
    }
}

func perform() async throws -> some IntentResult {

    await vpnService.connect()

    await waitForConnected()

    return .result(value: "VPN Connected")
}


status æ”¹å˜
â†“
yield
â†“
for await æ”¶åˆ°å€¼


å®Œæ•´ç‰ˆï¼ˆæ”¯æŒå¤šä¸ªè®¢é˜…è€…ï¼‰
actor VPNStateStore { // actor æ˜¯â€œæ„å›¾å£°æ˜â€ã€‚è¿™æ˜¯ä¸€ä¸ªå¹¶å‘éš”ç¦»çš„çŠ¶æ€ç®¡ç†å•å…ƒã€‚å¤šä¸ªçº¿ç¨‹ / å¤šä¸ª Task åŒæ—¶è°ƒç”¨ updateStatusï¼Œactor çš„ä»·å€¼æ‰çœŸæ­£ä½“ç°å‡ºæ¥ã€‚

    private var status: VPNStatus = .disconnected
    private var continuations: [AsyncStream<VPNStatus>.Continuation] = []

    func statusStream() -> AsyncStream<VPNStatus> {
        AsyncStream { continuation in
            continuations.append(continuation)

            // æ–°è®¢é˜…è€…ç«‹å³æ‹¿åˆ°å½“å‰çŠ¶æ€
            continuation.yield(status)

            continuation.onTermination = { @Sendable _ in
                Task { await self.removeContinuation(continuation) }
            }
        }
    }

    private func removeContinuation(
        _ continuation: AsyncStream<VPNStatus>.Continuation
    ) {
        continuations.removeAll { $0 === continuation }
    }

    func updateStatus(_ newStatus: VPNStatus) {
        guard status != newStatus else { return }

        status = newStatus
        continuations.forEach { $0.yield(newStatus) }
    }

    func currentStatus() -> VPNStatus {
        status
    }
}


extension VPNStateStore {
    func wait(for target: VPNStatus) async {
        for await status in await statusStream() {
            if status == target {
                return
            }
        }
    }
}
Intent é‡Œç›´æ¥ï¼š
await vpnStateStore.wait(for: .connected)


åŒä¸€æ—¶åˆ»ï¼Œactor å†…éƒ¨åªä¼šæœ‰ä¸€ä¸ª Task åœ¨æ‰§è¡Œï¼›
å…¶ä»–å¹¶å‘è°ƒç”¨ä¼šè¢«æŒ‚èµ·å¹¶æ’é˜Ÿï¼Œç­‰å‰ä¸€ä¸ªæ‰§è¡Œå®Œå†è¿›æ¥ã€‚


Task A â”€â”
Task B â”€â”¼â”€â–¶ actor mailbox â”€â–¶ æ‰§è¡Œ A â”€â–¶ æ‰§è¡Œ B â”€â–¶ æ‰§è¡Œ C
Task C â”€â”˜
actor æœ‰ä¸€ä¸ª éšå¼çš„ mailbox
æ‰€æœ‰å¯¹ actor éš”ç¦»æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šè¿›å…¥è¿™ä¸ªé˜Ÿåˆ—
ä¸²è¡Œæ‰§è¡Œ

é‡è¦ä½†å¿…é¡»è¯´æ¸…çš„ä¸€ç‚¹ï¼ˆé«˜çº§ï¼‰
actor â‰  â€œæ•´ä¸ªæ–¹æ³•æ‰§è¡ŒæœŸé—´éƒ½é”ä½â€
actor æ˜¯å¯é‡å…¥çš„ï¼ˆreentrantï¼‰

actor Example {
    func foo() async {
        print("A")
        await someAsyncCall()
        print("B")
    }
}

æ‰§è¡Œé¡ºåºå¯èƒ½æ˜¯ï¼š
Task 1: foo() â†’ print A â†’ await
Task 2: foo() â†’ print A â†’ await
Task 1: resume â†’ print B
Task 2: resume â†’ print B

åœ¨ await çš„æ—¶å€™ï¼š
actor ä¼šè®©å‡ºæ‰§è¡Œæƒ
å…¶ä»– Task å¯ä»¥è¿›å…¥ actor

ä½†æ³¨æ„ï¼š
åŒä¸€æ—¶åˆ»ä»ç„¶åªæœ‰ä¸€ä¸ª Task åœ¨æ‰§è¡Œ actor çš„ä»£ç 
åªæ˜¯æ‰§è¡Œæƒåœ¨ await ç‚¹åˆ‡æ¢ã€‚






ç°ä»£å¤šç›‘å¬è€…çš„ã€Œæ ‡å‡†ä¸‰ä»¶å¥—ã€
1ï¸âƒ£ çŠ¶æ€æºï¼šactor
actor VPNStateStore {
    private var status: VPNStatus = .disconnected
}
2ï¸âƒ£ äº‹ä»¶æµï¼šAsyncStream // AsyncSequence æ˜¯ async/await æ—¶ä»£çš„äº‹ä»¶æµ
func statusStream() -> AsyncStream<VPNStatus>
3ï¸âƒ£ æ¶ˆè´¹è€…ï¼šfor await
for await status in await vpnStateStore.statusStream() {
    ...
}