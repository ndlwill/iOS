åœ¨concurrencyç¯å¢ƒä¸­åˆ›å»ºçš„ Taskï¼š

func doSomething() async {
    print("11111#doSomething")
}

func load111() async {
    print("11111#load1")
    Task {
        print("11111#task1")
        await doSomething()
        print("11111#task2")
    }
    print("11111#load2")
}

override func viewDidLoad() {
    super.viewDidLoad()
    
    Task {
        await load111()
    }

    // 'async' call in a function that does not support concurrency
    // await load111()
    
}

11111#load1
11111#load2
11111#task1
11111#doSomething
11111#task2

è¿™ä¸ª Task {}ï¼š
æ˜¯ç»“æ„åŒ–ä»»åŠ¡ï¼ˆå› ä¸ºå®ƒåœ¨ async å‡½æ•°é‡Œåˆ›å»ºï¼‰ï¼›
ä½†ä½ æ²¡æœ‰ await å®ƒçš„ .value æˆ–ç»“æœï¼›
æ‰€ä»¥å®ƒæ˜¯å¼‚æ­¥â€œfire and forgetâ€åœ°å¼€å§‹æ‰§è¡Œï¼Œload111() ç»§ç»­å¾€ä¸‹èµ°ï¼Œä¸ä¼šç­‰å®ƒã€‚



å¦‚æœä½ å†™æˆè¿™æ ·å°±ä¼šç­‰å¾…äº†ï¼š
func load111() async {
    print("11111#load1")
    let t = Task {
        print("11111#task1")
        await doSomething()
        print("11111#task2")
    }
    await t.value // // æ‰‹åŠ¨ç­‰å¾…è¿™ä¸ªç»“æ„åŒ–ä»»åŠ¡å®Œæˆ
    print("11111#load2")
}
11111#load1
11111#task1
11111#doSomething
11111#task2
11111#load2

ã€Œä»»åŠ¡åœ¨è¿”å›å‰ç­‰å¾…å®Œæˆã€


å…¶ä»–ä¾‹å­:
func doSomething() async {
    try? await Task.sleep(nanoseconds: 2000000000)
    print("11111#doSomething")
}

func doSomething2() async {
    try? await Task.sleep(nanoseconds: 1000000000)
    print("11111#doSomething2")
}

func load111() async {
    print("11111#load1")
    let t = Task {
        print("11111#task1")
        await doSomething()
        print("11111#task2")
    }
    let t2 = Task {
        print("11111#task3")
        await doSomething2()
        print("11111#task4")
    }
    await t.value
    await t2.value
    print("11111#load2")
}

11111#load1
11111#task3
11111#task1
11111#doSomething2
11111#task4
11111#doSomething
11111#task2
11111#load2

ç”¨ async let æ”¹å†™ï¼Œæ•ˆæœåŸºæœ¬ä¸€è‡´

#####
ä½†ï¼š
async let åˆ›å»ºçš„æ˜¯ç»“æ„åŒ–å¹¶å‘ä»»åŠ¡ï¼Œè‡ªåŠ¨ç»‘å®šåˆ°å½“å‰ä»»åŠ¡ä½œç”¨åŸŸä¸­
æŠŠä½ çš„ async å‡½æ•°æƒ³è±¡æˆä¸€ä¸ªâ€œä»»åŠ¡æ ‘çš„èŠ‚ç‚¹â€ï¼š
ä½ æ¯è°ƒç”¨ä¸€ä¸ª async å‡½æ•°ï¼Œå®ƒå°±å˜æˆä¸€ä¸ªç»“æ„åŒ–ä»»åŠ¡ï¼›
ä½ åœ¨é‡Œé¢ç”¨ async let åˆ›å»ºçš„ä»»åŠ¡ï¼Œæ˜¯å®ƒçš„â€œå­ä»»åŠ¡â€ï¼›

Task {} æ˜¯éç»“æ„åŒ–å¹¶å‘ä»»åŠ¡ï¼Œç‹¬ç«‹è¿è¡Œï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†å¼•ç”¨å’Œç”Ÿå‘½å‘¨æœŸã€‚å®ƒä¸å±äºä»»ä½•å‡½æ•°çš„ä½œç”¨åŸŸ
#####

==================================================æµ‹è¯•
1.
@MainActor
class TestClass {
    func test() {
        print("TestClass=====111", Thread.current)
        Task {
            print("TestClass=====333", Thread.current)
        }
        print("TestClass=====222", Thread.current)
    }
}
TestClass=====111 <_NSMainThread: 0x60000170c040>{number = 1, name = main}
TestClass=====222 <_NSMainThread: 0x60000170c040>{number = 1, name = main}
TestClass=====333 <_NSMainThread: 0x60000170c040>{number = 1, name = main}


2.
class TestClass {
    func test() {
        print("TestClass=====111", Thread.current)
        Task {
            print("TestClass=====333", Thread.current)
        }
        print("TestClass=====222", Thread.current)
    }
}
TestClass=====111 <_NSMainThread: 0x60000170c040>{number = 1, name = main}
TestClass=====222 <_NSMainThread: 0x60000170c040>{number = 1, name = main}
TestClass=====333 <NSThread: 0x600001710380>{number = 6, name = (null)}


3.
@MainActor
class TestClass {
    func test() {
        print("TestClass=====111", Thread.current)
        Task.detached {
            print("TestClass=====333", Thread.current)
        }
        print("TestClass=====222", Thread.current)
    }
}
TestClass=====111 <_NSMainThread: 0x60000170c040>{number = 1, name = main}
TestClass=====222 <_NSMainThread: 0x60000170c040>{number = 1, name = main}
TestClass=====333 <NSThread: 0x600001710380>{number = 7, name = (null)}


4.
@MainActor
override func viewDidLoad() {
    super.viewDidLoad()
    
    print("=====111", Thread.current)
    Task {
        print("=====333", Thread.current)
    }
    print("=====222", Thread.current)
}
=====111 <_NSMainThread: 0x283dc8380>{number = 1, name = main}
=====222 <_NSMainThread: 0x283dc8380>{number = 1, name = main}
=====333 <_NSMainThread: 0x283dc8380>{number = 1, name = main}


5.
class Test {
    func test1() {
        print("===1111", Thread.current)
        Task {
            print("===111", Thread.current)
        }
    }
    
    @MainActor
    func test2() {
        print("===2222", Thread.current)
        Task {
/*
æ ‡è®°
@MainActor
func test2()
ä½¿ç”¨Thread.currentä¹Ÿä¼šè­¦å‘Š: 
Class property 'current' is unavailable from asynchronous contexts;
Thread.current cannot be used from async contexts.;
this is an error in the Swift 6 language mode
 */
            print("===222", Thread.current)
        }
    }
}

@MainActor
func application(_ application: UIApplication,
                     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
    let test = Test()
    test.test1()
    test.test2()                
}
===1111 <_NSMainThread: 0x2808d4380>{number = 1, name = main}
===2222 <_NSMainThread: 0x2808d4380>{number = 1, name = main}
/*
Task {} çš„é»˜è®¤è¡Œä¸ºæ˜¯ï¼š
ä»è°ƒç”¨ç‚¹æ•è·å…¶æ‰€åœ¨çš„ actorï¼ˆå¦‚ MainActorï¼‰

func test1()æ²¡æœ‰æ ‡è®°MainActorï¼Œå³ä½¿å®ƒåœ¨æ ‡è®°MainActorçš„didFinishLaunchingWithOptionsä¸­è¢«è°ƒç”¨
*/
===111 <NSThread: 0x280884280>{number = 6, name = (null)}
===222 <_NSMainThread: 0x2808d4380>{number = 1, name = main} 


==================================================Task { @MainActor in ... }
Task { @MainActor in ... } è¿™ä¸ªå†™æ³•å…¶å®æ˜¯ Swift 5.9ï¼ˆæ­£å¼æ”¯æŒï¼‰ å¼€å§‹æ”¯æŒçš„**â€œä»»åŠ¡å±€éƒ¨æ‰§è¡Œä¸Šä¸‹æ–‡æ ‡æ³¨â€**ï¼ˆtask local actor isolationï¼‰è¯­æ³•ç³–ã€‚
Task { @MainActor in ... } è®©ä½ å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä¸”ä»»åŠ¡å†…éƒ¨çš„ä»£ç è‡ªåŠ¨è¿è¡Œåœ¨ MainActor ä¸Šã€‚
è¿™æ˜¯å¯¹ä»¥å‰éœ€è¦å†™æˆ await MainActor.run { ... } çš„ç®€å†™ // Swift 5.5

Task { @MainActor in
    // è¿™é‡Œçš„ä»£ç è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œ
    print(Thread.current)
    // å¯ä»¥å®‰å…¨è®¿é—® UI ç›¸å…³ä»£ç 
}
ç­‰ä»·äºï¼š
Task {
    await MainActor.run {
        print(Thread.current)
    }
}

==================================================TaskGroupä¸­çš„ç»“æ„åŒ–å¹¶å‘ä»»åŠ¡
func loadAllImages(urls: [URL]) async -> [UIImage] {
    await withTaskGroup(of: UIImage?.self) { group in
        for url in urls {
            group.addTask {
                return await loadImage(url: url)
            }
        }

        var images: [UIImage] = []
        for await image in group {
            if let img = image {
                images.append(img)
            }
        }
        return images
    }
}
æ‰€æœ‰å­ä»»åŠ¡åœ¨ withTaskGroup ä½œç”¨åŸŸå†…å®Œæˆï¼›
è‡ªåŠ¨å¹¶å‘ã€è‡ªåŠ¨å–æ¶ˆã€è‡ªåŠ¨æ”¶é›†ï¼›
æ›´åŠ ç»“æ„åŒ–ã€å®‰å…¨ã€‚


==================================================ç»“æ„åŒ–ä»»åŠ¡ & ç»“æ„åŒ–å¹¶å‘
ç»“æ„åŒ–ä»»åŠ¡ = æœ‰çˆ¶ä»»åŠ¡ï¼ˆasyncä¸Šä¸‹æ–‡ï¼‰æ¥ç­‰å®ƒã€å–æ¶ˆå®ƒã€è·Ÿè¸ªå®ƒçš„ä»»åŠ¡ã€‚å¦åˆ™å°±æ˜¯â€œé‡ä»»åŠ¡â€ã€‚


"ç»“æ„åŒ–ä»»åŠ¡" æ˜¯ "ç»“æ„åŒ–å¹¶å‘" çš„ç»„æˆéƒ¨åˆ†ã€‚


ç»“æ„åŒ–å¹¶å‘ï¼ˆStructured Concurrencyï¼‰
æ˜¯ä¸€ç§æ•´ä½“å¹¶å‘æ¨¡å‹çš„è®¾è®¡æ€æƒ³ï¼š
å¹¶å‘ä»»åŠ¡åº”è¯¥åƒå‡½æ•°ä½œç”¨åŸŸä¸€æ ·ï¼Œæœ‰çˆ¶å­å…³ç³»ã€æœ‰ç”Ÿå‘½å‘¨æœŸã€è‡ªåŠ¨ç®¡ç†ã€æ˜“äºæ¨ç†ã€‚
å®ƒæ˜¯ä¸€å¥—åŸåˆ™ / çº¦æŸï¼ŒåŒ…æ‹¬ï¼š
çˆ¶å­ä»»åŠ¡ä¹‹é—´æœ‰ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼›
å­ä»»åŠ¡ä¸èƒ½â€œæ‚¬æŒ‚â€åœ¨ç³»ç»Ÿä¸­ï¼›
é”™è¯¯ä¼ æ’­æ˜¯å¯æ§çš„ï¼›
è‡ªåŠ¨ä¼ é€’å–æ¶ˆä¿¡å·ï¼›
ä½œç”¨åŸŸå†…çš„å¹¶å‘ä»»åŠ¡å¿…é¡»åœ¨é€€å‡ºå‰å®Œæˆã€‚


ç»“æ„åŒ–ä»»åŠ¡ï¼ˆStructured Taskï¼‰
æ˜¯è¿™ä¸ªæ¨¡å‹ä¸‹çš„å…·ä½“æ‰§è¡Œå•ä½ï¼Œä¹Ÿå°±æ˜¯å®é™…è¢«åˆ›å»ºå‡ºæ¥ã€å—æ§äºç»“æ„åŒ–ä½“ç³»çš„ Task å®ä¾‹ã€‚
æ¯”å¦‚ï¼š
async let åˆ›å»ºçš„ä»»åŠ¡
withTaskGroup ä¸­çš„ä»»åŠ¡
è¿™äº›éƒ½æ˜¯â€œç»“æ„åŒ–ä»»åŠ¡â€ï¼Œå› ä¸ºå®ƒä»¬ï¼š
æœ‰â€œçˆ¶ä»»åŠ¡â€ï¼ˆæ¯”å¦‚è°ƒç”¨å®ƒä»¬çš„ async å‡½æ•°ï¼‰
ä¼šåœ¨ä½œç”¨åŸŸç»“æŸå‰è¢«ç­‰å¾…å’Œæ¸…ç†
è¢« Swift ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶è‡ªåŠ¨ç®¡ç†


æ¦‚å¿µ	ç±»æ¯”
ç»“æ„åŒ–å¹¶å‘	æ³•å¾‹ã€åˆ¶åº¦ã€è§„åˆ™
ç»“æ„åŒ–ä»»åŠ¡	éµå®ˆè¿™ä¸ªåˆ¶åº¦çš„æ¯ä¸€ä¸ªå…·ä½“ä»»åŠ¡


func fetchData() async {
    async let user = loadUser()
    async let posts = loadPosts()
    let (u, p) = await (user, posts) // ğŸ‘ˆ ç»“æ„åŒ–ä»»åŠ¡å¿…é¡» await å›æ¥
}
è¿™é‡Œ loadUser() å’Œ loadPosts() å¯¹åº”çš„å°±æ˜¯ç»“æ„åŒ–ä»»åŠ¡ï¼›
è€Œæ•´ä¸ª fetchData() çš„è¡Œä¸ºï¼Œç¬¦åˆç»“æ„åŒ–å¹¶å‘çš„æ¨¡å‹ã€‚


ç»“æ„åŒ–å¹¶å‘æ˜¯æ¨¡å‹ï¼Œç»“æ„åŒ–ä»»åŠ¡æ˜¯è¿™ä¸ªæ¨¡å‹ä¸­çš„å…·ä½“ä»»åŠ¡å®ä¾‹ã€‚
æœ‰äº†ç»“æ„åŒ–å¹¶å‘çš„åŸåˆ™ï¼Œç»“æ„åŒ–ä»»åŠ¡æ‰èƒ½æœ‰æ„ä¹‰åœ°è¢«ç®¡ç†ã€‚