Swift ä¸­ async çš„çœŸæ­£è¯­ä¹‰ï¼š
åœ¨ Swift ä¸­ï¼Œasync è¡¨ç¤ºè¿™ä¸ªæ–¹æ³•æ˜¯ å¼‚æ­¥çš„ï¼Œè°ƒç”¨å®ƒæ—¶ä¸ä¼šç«‹å³å¾—åˆ°ç»“æœï¼Œè€Œæ˜¯éœ€è¦ä½¿ç”¨ await ç­‰å¾…å®ƒæ‰§è¡Œå®Œæˆåå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚
async æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¼šæŒ‚èµ·å½“å‰è°ƒç”¨è€…ï¼Œç­‰å®ƒå®Œæˆåå†ç»§ç»­æ‰§è¡Œè°ƒç”¨è€…å‰©ä¸‹çš„éƒ¨åˆ†ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼š
ä¸æ˜¯â€œå®ƒä¸»åŠ¨æŠŠæ•°æ®åŒæ­¥å›æ¥â€
è€Œæ˜¯ï¼šä½  await ç­‰å®ƒåšå®Œï¼Œä¹‹åç¨‹åºç»§ç»­æ‰§è¡Œ

ä½ å¯ä»¥æŠŠ await å½“æˆä¸€ä¸ªâ€œç¨‹åºæš‚åœç‚¹â€ï¼ŒæŒ‚èµ·å½“å‰ä»»åŠ¡ï¼Œç­‰ async æ–¹æ³•å®Œæˆåç»§ç»­æ‰§è¡Œã€‚



==================================================ä¸æ˜¯æ‰€æœ‰å¸¦ async çš„æ–¹æ³•éƒ½ä¼šåœ¨åå°æ‰§è¡Œ
async åªæ˜¯è¡¨ç¤ºâ€œå¯ä»¥æŒ‚èµ·ï¼ˆsuspendï¼‰â€ï¼Œå®ƒå¹¶ä¸æ„å‘³ç€è‡ªåŠ¨åœ¨åå°çº¿ç¨‹æ‰§è¡Œã€‚


async æ–¹æ³•åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ
async è¡¨ç¤ºè¿™ä¸ªå‡½æ•° å¯èƒ½ä¼šæŒ‚èµ·ï¼ˆæš‚åœï¼‰ç„¶åç¨åæ¢å¤æ‰§è¡Œã€‚
å®ƒå¯ä»¥åœ¨ä»»æ„çº¿ç¨‹/actor ä¸Šè¿è¡Œâ€”â€”ä¸»çº¿ç¨‹ã€åå°çº¿ç¨‹ã€MainActorã€Detached Taskï¼Œå–å†³äºï¼š
#####
è°è°ƒç”¨å®ƒï¼ˆåœ¨å“ªä¸ªçº¿ç¨‹/actorï¼‰
å®ƒå†…éƒ¨æ€ä¹ˆè°ƒåº¦
#####


ä¾‹å­ 1ï¼šURLSession.shared.data(for:)
let (data, _) = try await URLSession.shared.data(from: url)
è™½ç„¶æ˜¯ asyncï¼Œä½†å®ƒå†…éƒ¨ä½¿ç”¨äº† URLSessionï¼Œå…¶å·¥ä½œä¼šè‡ªåŠ¨è°ƒåº¦åˆ°åå°ï¼ˆä¸é˜»å¡å½“å‰çº¿ç¨‹ï¼‰ã€‚
ä½ å¯ä»¥åœ¨ä¸»çº¿ç¨‹è°ƒç”¨å®ƒï¼Œå®ƒä¹Ÿä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚
æ‰€ä»¥è¿™ä¸ª async æ–¹æ³•ç¡®å®åœ¨åå°æ‰§è¡Œæ ¸å¿ƒä»»åŠ¡ã€‚



ä¾‹å­ 2ï¼šä½ è‡ªå·±å†™çš„ async æ–¹æ³•ï¼Œæ²¡æœ‰åšä»»ä½•è°ƒåº¦
func doSomething() async {
    for i in 0..<1_000_000 { print(i) }
}
è™½ç„¶æ˜¯ asyncï¼Œä½†å®ƒæ²¡æœ‰è°ƒç”¨ awaitï¼Œä¹Ÿæ²¡æœ‰å†…éƒ¨è½¬çº¿ç¨‹ã€‚
å¦‚æœä½ åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œå®ƒä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼æ‰€ä»¥ ä¸èƒ½è®¤ä¸º async å°±è‡ªåŠ¨æ˜¯â€œåå°â€æ‰§è¡Œã€‚



æ³¨æ„ï¼š
class Test1 {
    func test1() async {
        print("===test1", Thread.current)
    }
}

@MainActor
class Test2 {
    func test2() async {
        print("===test2", Thread.current)
    }
}

@MainActor
func application(_ application: UIApplication,
                     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
    Task {
        print("===1", Thread.current)
        
        let test1 = Test1()
        await test1.test1()
    }
    
    Task {
        print("===2", Thread.current)
        
        let test2 = Test2()
        await test2.test2()
    }
}
===1 <_NSMainThread: 0x2837a4240>{number = 1, name = main}
===2 <_NSMainThread: 0x2837a4240>{number = 1, name = main}
===test2 <_NSMainThread: 0x2837a4240>{number = 1, name = main}
===test1 <NSThread: 0x2837fd780>{number = 9, name = (null)}



æ‰€ä»¥ï¼šè¦åˆ¤æ–­æ˜¯å¦åå°æ‰§è¡Œï¼Œçœ‹ä»€ä¹ˆï¼Ÿ
åˆ¤æ–­æ¡ä»¶	æ˜¯å¦åå°æ‰§è¡Œ
Task.detached {}	âœ… åå°ï¼ˆè„±ç¦»å½“å‰actorï¼‰
DispatchQueue.global().async	âœ… åå°
async + ç³»ç»Ÿ API å†…éƒ¨è°ƒåº¦ï¼ˆå¦‚ URLSessionï¼‰	âœ… èƒŒåç”±ç³»ç»Ÿè‡ªåŠ¨åå°
Task { @MainActor in ... }	âŒ ä¸»çº¿ç¨‹
Task { ... }ï¼ˆä¸åŠ  actorï¼‰	ğŸ” è·Ÿå½“å‰çº¿ç¨‹ä¸€è‡´ï¼›ä¸ä¿è¯æ˜¯åå°
@MainActor func	âŒ ä¸»çº¿ç¨‹æ‰§è¡Œ


å¦‚æœä½ å¸Œæœ›æ–¹æ³•åœ¨åå°çº¿ç¨‹æ‰§è¡Œï¼Œè¯· æ˜ç¡®è°ƒåº¦ï¼Œä¾‹å¦‚ï¼š
ç”¨ Task.detached {} åŒ…è£…
ç”¨ DispatchQueue.global() åŒ…è£…

æƒ³åœ¨ä¸»çº¿ç¨‹å®‰å…¨æ›´æ–° UIï¼Œç”¨ @MainActor æˆ– Task { @MainActor in ... }
Task { @MainActor in ... } è¿™ç§ inline actor-closureï¼ˆå†…è” actor é—­åŒ…è¯­æ³•ï¼‰ æ˜¯ Swift 5.9 æ–°å¢çš„è¯­æ³•


åœ¨ Swift 5.8 åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœä½ æƒ³è®© Task çš„æ‰§è¡Œå†…å®¹åœ¨ MainActor ä¸Šè¿è¡Œï¼Œå¸¸è§å†™æ³•å¦‚ä¸‹ï¼š
Task {
    await MainActor.run {
        // ä¸»çº¿ç¨‹ä»£ç 
        self.images = ...
    }
}


Task { @MainActor in
    // æ›´ç®€æ´ï¼Œç›´æ¥æŒ‡å®š actor
    self.images = ...
}
è¿™ç§æ–°è¯­æ³•æœ¬è´¨ä¸Šæ˜¯è¯­æ³•ç³–ï¼Œä½œç”¨ç­‰åŒäºï¼š
Task {
    await MainActor.run {
        ...
    }
}

xcrun swift -version
xcrun æ˜¯ Apple æä¾›çš„å·¥å…·ï¼Œç”¨æ¥åœ¨ å½“å‰ Xcode å‘½ä»¤è¡Œå·¥å…·é“¾ ä¸‹è¿è¡ŒæŒ‡å®šçš„å·¥å…·æˆ–å‘½ä»¤ï¼Œæ¯”å¦‚ swiftã€clangã€simctl ç­‰ã€‚
macOS å¯ä»¥åŒæ—¶å®‰è£…å¤šä¸ª Xcodeï¼ˆæ¯”å¦‚ /Applications/Xcode_14.app, /Applications/Xcode_15.app ç­‰ï¼‰ï¼Œè¿™æ—¶ï¼š
xcrun ä¼šä½¿ç”¨å½“å‰è®¾ç½®çš„å‘½ä»¤è¡Œå¼€å‘å·¥å…·ï¼ˆCommand Line Toolsï¼‰ã€‚
ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹æˆ–è®¾ç½®å½“å‰ä½¿ç”¨å“ªä¸ª Xcodeï¼š
xcode-select -p