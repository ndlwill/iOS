https://fatbobman.com/zh/posts/sendable-sending-nonsending/

Swift å¹¶å‘ä¸­ä¸è·¨éš”ç¦»åŸŸä¼ é€’ç›¸å…³çš„å‡ ä¸ªå…³é”®å­—ï¼šSendableã€@unchecked Sendableã€@Sendableã€sending å’Œ nonsending


==================================================éš”ç¦»åŸŸï¼ˆIsolation Domainï¼‰
Swift åœ¨æ„å»ºæ–°çš„å¹¶å‘æ¨¡å‹æ—¶å¼•å…¥äº†éš”ç¦»åŸŸçš„æ¦‚å¿µã€‚
å¼€å‘è€…å¯ä»¥é€šè¿‡ actorã€@MainActor æˆ–å…¶ä»–è‡ªå®šä¹‰çš„ Global Actor æ¥å£°æ˜ä¸€ä¸ªéš”ç¦»åŸŸã€‚
æ¯ä¸ªéš”ç¦»åŸŸå®ä¾‹éƒ½ä¼šé€šè¿‡å…¶ Executorï¼ˆæ‰§è¡Œå™¨ï¼‰ æ¥ç»´æŠ¤å’Œç®¡ç†ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨è®¿é—®å—ä¿æŠ¤çš„çŠ¶æ€ï¼Œä»è€Œå°†æ•°æ®ç«äº‰ä»è¿è¡Œæ—¶é”™è¯¯è½¬å˜ä¸ºç¼–è¯‘æ—¶é”™è¯¯ã€‚

æ­£å› ä¸ºæœ‰äº†æ˜ç¡®çš„éš”ç¦»åŸŸè¾¹ç•Œï¼Œå¼€å‘è€…å°±éœ€è¦ä¸ºæ•°æ®ç±»å‹æˆ–æ¥æ”¶ç«¯æ·»åŠ ç‰¹å®šçš„æ ‡æ³¨ï¼Œè®©ç¼–è¯‘å™¨èƒ½å¤Ÿæ£€æŸ¥æ•°æ®æ˜¯å¦å¯ä»¥åœ¨ä¸åŒçš„éš”ç¦»åŸŸä¹‹é—´å®‰å…¨ä¼ é€’ã€‚
å› æ­¤ï¼Œä¸€ç³»åˆ—åŒ…å« â€œSendâ€ è¯­ä¹‰çš„å…³é”®å­—å’Œåè®®åº”è¿è€Œç”Ÿã€‚


==================================================Sendable
å€¼ç±»å‹åœ¨ Swift ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå…¶å¤åˆ¶è¯­ä¹‰å¤©ç„¶é€‚åˆåœ¨ä¸åŒçš„éš”ç¦»åŸŸä¹‹é—´ä¼ é€’ã€‚
#####
ä½†ç”±äºè‡ªå®šä¹‰ç±»å‹ä¸­å¯èƒ½åŒ…å«ä¸èƒ½å®‰å…¨ä¼ é€’çš„æˆå‘˜ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ  Sendable æ ‡æ³¨ï¼Œè®©ç¼–è¯‘å™¨å¸®åŠ©éªŒè¯å…¶å®‰å…¨æ€§ã€‚
è™½ç„¶ Sendable ä»¥åè®®å½¢å¼å‡ºç°ï¼Œä½†æœ¬è´¨ä¸Šå®ƒæ˜¯ä¸€ä¸ªç¼–è¯‘æ—¶å¥‘çº¦ï¼Œå£°æ˜æŸä¸ªç±»å‹å¯ä»¥å®‰å…¨åœ°è·¨éš”ç¦»åŸŸä¼ é€’ï¼Œç¼–è¯‘å™¨ä¼šéªŒè¯è¿™ä¸ªå£°æ˜çš„çœŸå®æ€§ã€‚
#####

// Sendable æ˜¯ä¸€ä¸ªæ ‡è®°åè®®ï¼ˆmarker protocolï¼‰
protocol Sendable { }
// å®ƒå‘Šè¯‰ç¼–è¯‘å™¨ï¼š"è¿™ä¸ªç±»å‹è·¨éš”ç¦»åŸŸä¼ é€’æ˜¯å®‰å…¨çš„"

å¯¹äºæ˜æ˜¾ç¬¦åˆ Sendable ç‰¹æ€§çš„ç±»å‹ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ¨æ–­ï¼Œå³ä½¿ä¸æ˜¾å¼æ·»åŠ  Sendable æ ‡æ³¨ï¼Œç¼–è¯‘å™¨ä»ä¼šç¡®ä¿å…¶æ»¡è¶³è·¨éš”ç¦»åŸŸå®‰å…¨ä¼ é€’çš„è¦æ±‚ï¼š

func getSendable<T:Sendable>(value:T) {}

struct People { // å€¼ç±»å‹
    var name:String // å±æ€§éƒ½æ˜¯ Sendable
    var age:Int
}

let people = People(name: "", age: 10)
getSendable(value: people) // è‡ªåŠ¨æ¨æ–­ä¸º Sendable


åœ¨ Swift 6 ä¸­ï¼ŒæŸäº›ä¹‹å‰å¯ä»¥è‡ªåŠ¨æ¨æ–­çš„åœºæ™¯ä¸å†è¢«æ”¯æŒï¼š
final class NoNeedMarkSendable {
    let name = "fat"
}
let a = NoNeedMarkSendable()
getSendable(value: a) // Swift 6 ä¹‹å‰æˆ–æ²¡æœ‰å¼€å¯ä¸¥æ ¼å¹¶å‘æ£€æŸ¥ âœ…
getSendable(value: a) // Swift 6 ä¹‹å âŒï¼š Type 'NoNeedMarkSendable' does not conform to the 'Sendable' protocol

ä¸ºäº†ç¡®ä¿ä»£ç çš„å¥å£®æ€§ï¼Œå»ºè®®å¼€å‘è€…æ˜¾å¼æ·»åŠ  Sendable æ ‡æ³¨ã€‚

å¦å¤–ï¼Œå¦‚æœä¸€ä¸ªç±»å‹å…·æœ‰æ˜ç¡®çš„éš”ç¦»åŸŸï¼ˆå¦‚ actor ç±»å‹æˆ–æ ‡è®°ä¸º @MainActor çš„ç±»ï¼‰ï¼Œå®ƒæœ¬èº«å°±è¢«è§†ä¸º Sendableï¼Œå› ä¸ºå…¶å†…éƒ¨çŠ¶æ€å·²ç”± Swift å¹¶å‘æ¨¡å‹æä¾›éš”ç¦»ä¿éšœï¼š
@MainActor
final class NoNeedMarkSendable {
    let name = "fat"
}

Task { @MainActor in
  let a = NoNeedMarkSendable()
  getSendable(value: a) // âœ… @MainActor ç±»å‹è‡ªåŠ¨ Sendable
}
Sendable é€šå¸¸ä½œä¸ºæ³›å‹çº¦æŸä½¿ç”¨ï¼Œåœ¨ç¼–è¯‘æ—¶ç¡®ä¿åªæ¥å—å¯å®‰å…¨ä¼ é€’çš„ç±»å‹ã€‚


==================================================@unchecked Sendable
åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œç‰¹åˆ«æ˜¯å¤„ç†é—ç•™ä»£ç æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½å·²ç»é€šè¿‡å…¶ä»–æœºåˆ¶ï¼ˆå¦‚é”ã€é˜Ÿåˆ—ç­‰ï¼‰ç¡®ä¿äº†çº¿ç¨‹å®‰å…¨ï¼Œä½†ç¼–è¯‘å™¨æ— æ³•ç†è§£è¿™äº›å®ç°ã€‚
#####
æ­¤æ—¶ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ @unchecked Sendable å‘ç¼–è¯‘å™¨ä¿è¯ç±»å‹çš„å®‰å…¨æ€§ï¼Œä»è€Œç»•è¿‡ç¼–è¯‘å™¨çš„è‡ªåŠ¨æ£€æŸ¥ï¼š
#####

final class ThreadSafeCache: @unchecked Sendable {
    private var cache: [String: Sendable] = [:]
    // è™½ç„¶æœ‰å¯å˜çŠ¶æ€ï¼Œä½†é€šè¿‡é˜Ÿåˆ—ä¿è¯äº†çº¿ç¨‹å®‰å…¨
    private let queue = DispatchQueue(label: "cache", attributes: .concurrent)
    
    func get(_ key: String) -> Sendable? {
        queue.sync {
            cache[key]
        }
    }
    
    func set(_ key: String, value: Sendable) {
        queue.async(flags: .barrier) {
            self.cache[key] = value
        }
    }
}
éœ€è¦è­¦æƒ•çš„æ˜¯ï¼Œä¸€äº›å¼€å‘è€…ä¸ºäº†è®©ä»£ç é€šè¿‡ç¼–è¯‘ä¼šæ»¥ç”¨ @unchecked Sendableï¼Œè¿™ä¼šä½¿ä¸¥æ ¼å¹¶å‘æ£€æŸ¥å¤±å»æ„ä¹‰ã€‚

ä» Swift 6 å¼€å§‹ï¼ŒSynchronization æ¡†æ¶æä¾›çš„ Mutex ç±»å‹å¯ä»¥å®ç°çœŸæ­£çš„ Sendableï¼Œæ— éœ€å†ä¾èµ– @uncheckedï¼š
import Synchronization

final class ThreadSafeCache: Sendable {
    private let cache = Mutex<[String: Sendable]>([:])

    func get(_ key: String) -> Sendable? {
        cache.withLock {
            $0[key]
        }
    }

    func set(_ key: String, value: Sendable) {
        cache.withLock {
            $0[key] = value
        }
    }
}

==================================================@Sendable
ç”±äº Sendable åè®®åªèƒ½ç”¨äºç±»å‹å£°æ˜ï¼ŒSwift ä¸ºé—­åŒ…æä¾›äº†ä¸“é—¨çš„å±æ€§ @Sendableã€‚å®ƒè¡¨ç¤ºé—­åŒ…å¯ä»¥å®‰å…¨åœ°è·¨éš”ç¦»åŸŸä¼ é€’ï¼š
func getSendableClosure(perform: @escaping @Sendable () -> Void ) {}

ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘é˜¶æ®µæ£€æŸ¥é—­åŒ…çš„å®‰å…¨æ€§ï¼š
final class NoNeedMarkSendable {
    let name = "fat"
}

let a = NoNeedMarkSendable()
getSendableClosure(perform: { a }) // âŒ Capture of 'a' with non-Sendable type 'NoNeedMarkSendable' in a '@Sendable' closure

getSendableClosure(perform: {
   let a = NoNeedMarkSendable() // âœ… åœ¨é—­åŒ…å†…éƒ¨åˆ›å»ºï¼Œä¸å­˜åœ¨è·¨éš”ç¦»åŸŸä¼ é€’
})


==================================================sending
#####
@Sendable é—­åŒ…çš„é™åˆ¶æœ‰æ—¶è¿‡äºä¸¥æ ¼ã€‚è€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼š
#####
Task {
    let nonSendable = NonSendableClass()
    getSendableClosure {
        nonSendable.value += 1 // Capture of 'nonSendable' with non-Sendable type 'NonSendableClass' in a '@Sendable' closure
    }
    // å®é™…ä¸Šè¿™é‡Œæ˜¯å®‰å…¨çš„ï¼Œå› ä¸º nonSendable ä¸ä¼šåœ¨å…¶ä»–åœ°æ–¹è¢«ä¿®æ”¹
}

#####
Swift 6 å¼•å…¥äº† sending å‚æ•°ä¿®é¥°ç¬¦æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š
#####

// åŸæ¥çš„
func getSendableClosure(perform: @escaping @Sendable  () -> Void) {}

// æ–°çš„
func getSendableClosure(sending perform: @escaping  () -> Void) {}

Task {
    let nonSendable = NonSendableClass()
    getSendableClosure {
        nonSendable.value += 1 // âœ… æ¢æˆ `sending` å
    }
}

#####
ä½† sending å¹¶éåƒ @unchecked Sendable ä¸€æ ·ï¼Œä¼šç»•è¿‡ Swift ç¼–è¯‘å™¨çš„æ£€æŸ¥ã€‚
å¦‚æœå‡ºç°äº†ä¸å®‰å…¨çš„ä½¿ç”¨åœºæ™¯ï¼Œç¼–è¯‘å™¨ä»ç„¶ä¼šæé†’æˆ‘ä»¬ï¼š
#####
actor MyActor {
    var storage: NonSendableClass?
    
    // ä½¿ç”¨ sending å…è®¸æ¥æ”¶é Sendable å‚æ•°
    func store(_ object: sending NonSendableClass) {
        storage = object 
    }
}

Task {
    let obj = NonSendableClass()
    let myActor = MyActor()
    await myActor.store(obj) // âœ… æ‰€æœ‰æƒè½¬ç§»ç»™ actor
    // obj.value += 1 // âŒ 'obj' used after being passed as a 'sending' parameter
}
#####
è¿™æ˜¯å› ä¸ºï¼Œsending çš„æ ¸å¿ƒæ¦‚å¿µæ˜¯â€œè½¬ç§»æ‰€æœ‰æƒâ€ï¼Œå°½ç®¡ç¼–è¯‘å™¨ä¸å†å¯¹ Sendable è¿›è¡Œæ£€æŸ¥ï¼Œä½†æ˜¯ä¼šå¯¹æ‰€æœ‰æƒè¿›è¡Œæ£€æŸ¥ã€‚
åœ¨è½¬ç§»åï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨å…¶ä»–åœ°æ–¹å†ä½¿ç”¨å·²è½¬ç§»çš„å€¼ï¼
#####

sending æ›´é€‚åˆçš„åœºæ™¯æ˜¯ï¼š
è¿ç§»é Sendable çš„é—ç•™ä»£ç 
ä»»åŠ¡ç»“æœä¼ é€’ï¼ˆSwift 6 ä¸­ï¼ŒTask çš„å®ç°å·²ä» @Sendable æ”¹ä¸º sendingï¼‰

@Sendable æ˜¯ç±»å‹å®‰å…¨åœ°â€œå£°æ˜çº¿ç¨‹å®‰å…¨â€ï¼Œè€Œ sending æ˜¯æ‰€æœ‰æƒè¯­ä¹‰ä¸Šçš„â€œä¿è¯å•ä¸€ä½¿ç”¨æƒâ€


==================================================nonsending
#####
nonsending ä¸å‰é¢çš„å…³é”®å­—åœ¨è¯­ä¹‰ä¸Šæœ‰æœ¬è´¨åŒºåˆ«ã€‚å®ƒä¸ nonisolated é…åˆä½¿ç”¨
nonisolated(nonsending)ï¼Œè¡¨ç¤ºå¼‚æ­¥æ–¹æ³•åº”è¯¥ç»§æ‰¿è°ƒç”¨è€…çš„éš”ç¦»åŸŸï¼Œè€Œä¸æ˜¯è„±ç¦»å½“å‰éš”ç¦»åŸŸè¿è¡Œã€‚
#####

è¿™æ˜¯ Swift 6.2 å¯¹ nonisolated è¡Œä¸ºçš„é‡è¦è°ƒæ•´ã€‚åœ¨ Swift 6.2 ä¹‹å‰ï¼š
@MainActor
class RunInMainActor {    
    var name: String = "example"
    
    nonisolated func processData() async {
        // Swift 6.2 ä¹‹å‰ï¼šæ€»æ˜¯è„±ç¦» MainActor è¿è¡Œï¼ˆéä¸»çº¿ç¨‹ï¼‰
    }
}
ä½¿ç”¨ nonisolated(nonsending) åï¼š
@MainActor
class RunInMainActor {    
    var name: String = "example"
    
    nonisolated(nonsending) func processData() async {
        // #####Swift 6.2ï¼šç»§æ‰¿è°ƒç”¨è€…çš„éš”ç¦»åŸŸ#####
        // ä» MainActor è°ƒç”¨æ—¶è¿è¡Œåœ¨ä¸»çº¿ç¨‹
        // ä»å…¶ä»– actor è°ƒç”¨æ—¶è¿è¡Œåœ¨å¯¹åº”çš„éš”ç¦»åŸŸ
    }
}

å¼€å‘è€…è¿˜å¯ä»¥é€šè¿‡å¯ç”¨ NonisolatedNonsendingByDefault æ ‡å¿—ä½¿è¯¥è¡Œä¸ºæˆä¸ºé»˜è®¤è®¾ç½®ã€‚



==================================================

ğŸ”‘ å…³é”®å­—	ğŸ§­ ç”¨é€”	ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯	ğŸ›¡ï¸ ç¼–è¯‘å™¨è¡Œä¸º	âœ… å®‰å…¨ä¿è¯æ–¹å¼
Sendable	ç±»å‹æ ‡è®°	è·¨éš”ç¦»åŸŸä¼ é€’ç±»å‹	âœ… ç¼–è¯‘å™¨éªŒè¯ç±»å‹æ˜¯å¦çº¿ç¨‹å®‰å…¨	âœ… è‡ªåŠ¨æˆ–æ˜¾å¼å£°æ˜
@unchecked Sendable	è·³è¿‡ç±»å‹éªŒè¯	é—ç•™ä»£ç ã€æ‰‹åŠ¨ä¿éšœçº¿ç¨‹å®‰å…¨	âš ï¸ ç»•è¿‡æ£€æŸ¥ï¼Œå®Œå…¨ä¾èµ–å¼€å‘è€…åˆ¤æ–­	âš ï¸ ä¾èµ–å¼€å‘è€…ä¿è¯
@Sendable	é—­åŒ…å±æ€§æ ‡è®°	è·¨éš”ç¦»åŸŸä¼ é€’é—­åŒ…	âœ… ç¼–è¯‘å™¨æ£€æŸ¥æ•è·å€¼æ˜¯å¦ Sendable	âœ… è‡ªåŠ¨æ£€æŸ¥
sending	å‚æ•°ä¿®é¥°	æ‰€æœ‰æƒè½¬ç§»ã€æ„å»ºå™¨æ¨¡å¼	ğŸš« ä¸æ£€æŸ¥ Sendableï¼Œä½†ç¦æ­¢å†æ¬¡ä½¿ç”¨	ğŸš« æ‰€æœ‰æƒè¯­ä¹‰ï¼ˆé˜²æ­¢è¯¯ç”¨ï¼‰
nonsending	éš”ç¦»ç»§æ‰¿ä¿®é¥°ç¬¦	ä¿æŒè°ƒç”¨è€…éš”ç¦»åŸŸï¼Œé€‚é…å¼‚æ­¥è°ƒç”¨	âœ… æ§åˆ¶è¿è¡Œæ—¶éš”ç¦»ä¸Šä¸‹æ–‡	âœ… è¡Œä¸ºç”±è°ƒç”¨è€…ä¸Šä¸‹æ–‡å†³å®š



==================================================å¦‚ä½•ä½¿ç”¨ Mutex æ›¿æ¢ @unchecked Sendableï¼Ÿ
https://fatbobman.com/zh/snippet/replace-unchecked-sendable-with-mutex/